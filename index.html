<!DOCTYPE html>
<html lang="si">
  <head>
    <meta charset="utf-8"/>
    <title>Leaf Recognition ‚Äî Scan Capture</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{
        --accent: #4caf50;
        --bg: #f4f9f4;
        --card: #ffffff;
      }
      body{
        font-family: Arial, sans-serif;
        background: var(--bg);
        color:#222;
        margin:18px;
        text-align:center;
      }
      h1{ margin:6px 0 2px 0; }
      p.lead{ margin:0 0 14px 0; color:#444; }

      /* Controls */
      #controls{ margin:12px 0; }
      button{
        background:var(--accent); color:#fff; border:none; padding:10px 14px;
        border-radius:8px; cursor:pointer; font-weight:600; margin:0 6px;
      }
      button.stop{ background:#f44336; }

      /* layout */
      .wrap{
        display:flex; gap:18px; justify-content:center; flex-wrap:wrap; align-items:flex-start;
      }
      /* preview area */
      .previewCard{
        width:340px; background:var(--card); border-radius:12px; padding:12px;
        box-shadow:0 8px 22px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04);
      }
      #webcam-container{
        width:320px; height:320px; margin:6px auto; position:relative; overflow:hidden;
        border-radius:8px; border:2px solid rgba(76,175,80,0.15);
        background:#000;
      }
      /* the canvas will be appended here */
      #webcam-container canvas{ width:100%; height:100%; display:block; }

      /* scanner overlay */
      .scanner{
        position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none;
      }
      .scan-line{
        position:absolute; left:-100%; right:-10%; height:400px; top:0;
        background: linear-gradient(180deg, rgba(255, 0, 0, 0) 0%, rgba(0, 119, 255, 0.15) 45%, rgba(255,255,255,0.25) 55%, rgba(255,255,255,0) 100%);
        transform:translateY(-100%);
        filter: drop-shadow(0 6px 10px rgb(0, 0, 0));
      }
      /* when scanning, animate scan-line down */
      .scanning .scan-line{
        animation: scanMove 0.7s linear forwards;
      }
      @keyframes scanMove {
        0%{ transform:translateY(-120%); opacity:0; }
        10%{ opacity:1; }
        100%{ transform:translateY(120%); opacity:0; }
      }

      /* flash when capture */
      .flash {
        position:absolute; left:0; right:0; top:0; bottom:0; background:white; opacity:0; pointer-events:none;
        transition: opacity 0.12s ease;
      }
      .flash.visible{ opacity:0.7; }

      /* labels and top prediction */
      #label-container{ text-align:left; margin-top:8px; font-size:0.95rem; color:#222; }
      .predRow{ padding:4px 6px; border-radius:6px; margin:4px 0; background:rgba(0,0,0,0.02); display:flex; justify-content:space-between; align-items:center; }
      #topPredictionBox{
        margin-top:10px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#eafaf0);
        border:1px solid rgba(76,175,80,0.18); font-weight:700; display:none; text-align:left;
      }

      /* gallery */
      .rightCol{ width:540px; max-width:90%; }
      .galleryCard{ background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
      #gallery{ display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-start; margin-top:10px; }
      .captureCard{ width:160px; border-radius:8px; overflow:hidden; background:#fff; border:1px solid #eee; padding:6px; text-align:center; }
      .captureCard img{ width:100%; height:110px; object-fit:cover; border-radius:6px; display:block; }
      .meta{ font-size:0.82rem; color:#333; margin-top:6px; }
      .downloadBtn{ display:inline-block; margin-top:6px; padding:6px 8px; border-radius:6px; background:var(--accent); color:#fff; text-decoration:none; font-size:0.82rem; }

      /* small responsiveness */
      @media (max-width:900px){
        .wrap{ flex-direction:column; align-items:center; }
        .rightCol{ width:92%; }
      }
    </style>
  </head>

<body>
  <h1>Leaf Recognition ‚Äî Scan Capture</h1>
  <p class="lead">Live preview ‡∑Ñ‡∑í scanning animation ‚Üí random capture (1‚Äì5s) ‚Üí gallery ‡∂ë‡∂ö‡∂ß save + top prediction box</p>

  <div id="controls">
    <button id="startBtn">Start Webcam & Model</button>
    <button id="stopBtn" class="stop" style="display:none;">Stop</button>
  </div>

  <div class="wrap">
    <div class="previewCard">
      <div id="webcam-container">
        <!-- webcam canvas appended here -->
        <div class="scanner" id="scannerOverlay">
          <div class="scan-line"></div>
        </div>
        <div class="flash" id="flashOverlay"></div>
      </div>

      <div id="topPredictionBox">
        <span id="topLabel">‚Äî</span>
        <span style="float:right;font-weight:800;" id="topPercent">‚Äî</span>
        <div style="clear:both; margin-top:6px; font-size:0.9rem; color:#444;">Captured at: <span id="topTime">‚Äî</span></div>
      </div>
      <br>
      <button id="toggleResultsBtn">üëÅ Show/Hide Results</button>
      <table id="label-table" style="margin: 10px auto; border-collapse: collapse; display: table;">
          <thead>
              <tr>
                  <th style="border:1px solid #ccc; padding:5px;">Details</th>
              </tr>
          </thead>
          <tbody id="label-container"></tbody>
      </table>

      <div id="label-container"></div>
    </div>

    <div class="rightCol galleryCard">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Captured Images</strong>
        <small style="color:#181313; font-size:0.9rem;">Max: <span id="maxPhotosLabel">Loading...</span></small>
      </div>
      <div id="gallery" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- TensorFlow.js & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // ---- CONFIG ----
    const URL = "./";           // model folder path
    const CAPTURE_WIDTH = 320;
    const CAPTURE_HEIGHT = 320;
    const MIN_DELAY_MS = 1;           // 1 ms
    const MAX_DELAY_MS = 5000;           // 5 seconds
    const MAX_PHOTOS = 3;               // gallery limit
    const SCAN_DURATION_MS = 70;        // how long the scan animation runs before capture
    // ----------------

    // state
    let model, webcam, maxPredictions;
    let running = false;
    let captureTimer = null;

    // elements
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const webcamContainer = document.getElementById("webcam-container");
    const scannerOverlay = document.getElementById("scannerOverlay");
    const flashOverlay = document.getElementById("flashOverlay");
    const topBox = document.getElementById("topPredictionBox");
    const topLabel = document.getElementById("topLabel");
    const topPercent = document.getElementById("topPercent");
    const topTime = document.getElementById("topTime");
    const labelContainer = document.getElementById("label-container");
    const gallery = document.getElementById("gallery");
    document.getElementById("maxPhotosLabel").innerText = MAX_PHOTOS;

    startBtn.addEventListener("click", startAll);
    stopBtn.addEventListener("click", stopAll);

    async function startAll(){
      startBtn.disabled = true;
      startBtn.innerText = "Loading model...";
      try {
        // progress UI simple (could be improved)
        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();
      } catch(err){
        alert("Model load failed. Serve files via HTTP (e.g., python -m http.server). Error in console.");
        console.error(err);
        startBtn.disabled = false;
        startBtn.innerText = "Start Webcam & Model";
        return;
      }

      // setup webcam
      const flip = true;
      webcam = new tmImage.Webcam(CAPTURE_WIDTH, CAPTURE_HEIGHT, flip);
      await webcam.setup();
      await webcam.play();

      // clear container and append canvas
      webcamContainer.querySelectorAll("canvas").forEach(n => n.remove());
      webcamContainer.appendChild(webcam.canvas);

      // prepare labels
      labelContainer.innerHTML = "";
      for(let i=0;i<maxPredictions;i++){
        const div = document.createElement("div");
        div.className = "predRow";
        div.innerHTML = `<span id="pn_${i}">‚Äî</span><span id="pp_${i}">‚Äî</span>`;
        labelContainer.appendChild(div);
      }

      running = true;
      stopBtn.style.display = "inline-block";
      startBtn.innerText = "Running";

      // start render loop
      window.requestAnimationFrame(loop);

      // start capture scheduler
      scheduleNextCapture();
    }
    // Show/Hide toggle for table
        document.getElementById("toggleResultsBtn").addEventListener("click", () => {
            const table = document.getElementById("label-table");
            if (table.style.display === "none") {
                table.style.display = "table";
            } else {
                table.style.display = "none";
            }
        });

    function stopAll(){
      running = false;
      if (webcam) webcam.stop();
      if (captureTimer) clearTimeout(captureTimer);
      startBtn.disabled = false;
      startBtn.innerText = "Start Webcam & Model";
      stopBtn.style.display = "none";
      topBox.style.display = "none";
    }

    async function loop(){
      if (!running) return;
      webcam.update();
      await predict(false); // update live labels, but don't force show top box flash
      window.requestAnimationFrame(loop);
    }

    async function predict(showTop=true){
      if (!model) return;
      const prediction = await model.predict(webcam.canvas);
      let best = prediction[0];
      for (let i=0;i<prediction.length;i++){
        const name = prediction[i].className;
        const prob = (prediction[i].probability * 100);
        const elName = document.getElementById(`pn_${i}`);
        const elProb = document.getElementById(`pp_${i}`);
        if (elName) elName.innerText = name;
        if (elProb) elProb.innerText = prob.toFixed(2) + "%";
        if (prediction[i].probability > best.probability) best = prediction[i];
      }
      if (showTop && best){
        showTopPrediction(best.className, (best.probability*100).toFixed(2));
      }
      return prediction;
    }

    function showTopPrediction(name, percent){
      topLabel.innerText = name;
      topPercent.innerText = percent + "%";
      topTime.innerText = new Date().toLocaleTimeString();
      topBox.style.display = "block";
    }

    // schedule next random capture
    function scheduleNextCapture(){
      if (!running) return;
      const delay = Math.floor(Math.random() * (MAX_DELAY_MS - MIN_DELAY_MS + 1)) + MIN_DELAY_MS;
      captureTimer = setTimeout(async ()=>{
        // start scan animation, then capture after SCAN_DURATION_MS
        startScanAnimation();
        setTimeout(async ()=>{
          await performCapture();    // actual capture
          stopScanAnimation();
          scheduleNextCapture();     // queue next
        }, SCAN_DURATION_MS);
      }, delay);
    }

    function startScanAnimation(){
      scannerOverlay.classList.add("scanning");
    }
    function stopScanAnimation(){
      scannerOverlay.classList.remove("scanning");
    }

    async function performCapture(){
      if (!webcam || !model) return;
      // compute fresh prediction
      const prediction = await model.predict(webcam.canvas);
      let best = prediction[0];
      for (let i=1;i<prediction.length;i++){
        if (prediction[i].probability > best.probability) best = prediction[i];
      }

      // flash effect
      flashOverlay.classList.add("visible");
      setTimeout(()=> flashOverlay.classList.remove("visible"), 200);

      // snapshot
      const off = document.createElement("canvas");
      off.width = CAPTURE_WIDTH;
      off.height = CAPTURE_HEIGHT;
      const ctx = off.getContext("2d");
      // draw current webcam canvas content
      ctx.drawImage(webcam.canvas, 0, 0, off.width, off.height);
      const dataURL = off.toDataURL("image/png");

      // build capture card
      const card = document.createElement("div");
      card.className = "captureCard";
      const img = document.createElement("img");
      img.src = dataURL;
      const meta = document.createElement("div");
      meta.className = "meta";
      const now = new Date();
      const timeStr = now.toLocaleString();
      const predText = best ? `${best.className} (${(best.probability*100).toFixed(2)}%)` : "‚Äî";
      meta.innerHTML = `<strong>${predText}</strong><br><small>${timeStr}</small>`;

      const dl = document.createElement("a");
      dl.className = "downloadBtn";
      dl.href = dataURL; dl.download = `leaf_capture_${now.getTime()}.png`;
      dl.innerText = "Download";

      card.appendChild(img);
      card.appendChild(meta);
      card.appendChild(dl);

      // insert newest at top
      gallery.insertBefore(card, gallery.firstChild);

      // update top prediction box with capture info
      showTopPrediction(best.className, (best.probability*100).toFixed(2));
      topTime.innerText = timeStr;

      // enforce gallery limit
      while (gallery.childNodes.length > MAX_PHOTOS){
        gallery.removeChild(gallery.lastChild);
      }
    }

    // optional: clean up on page unload
    window.addEventListener("beforeunload", ()=>{
      if (webcam) try{ webcam.stop(); }catch(e){}
    });

  </script>

  
</body>
</html>
