<!-- paste/replace your existing file contents with this full HTML -->
<!DOCTYPE html>
<html lang="si">
  <head>
    <meta charset="utf-8"/>
    <title>Leaf Recognition ‚Äî Scan Capture (Ask AI)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      :root{ --accent: #4caf50; --bg: #f4f9f4; --card: #ffffff; }
      body{ font-family: Arial, sans-serif; background: var(--bg); color:#222; margin:1px; text-align:center; }
      h1{ margin:6px 0 2px 0; } p.lead{ margin:0 0 14px 0; color:#444; }
      #controls{ margin:12px 0; }
      button{ background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; margin:0 6px; }
      button.stop{ background:#f44336; }
      .wrap{ display:flex; gap:18px; justify-content:center; flex-wrap:wrap; align-items:flex-start; }
      .previewCard{ width:340px; background:var(--card); border-radius:12px; padding:12px; box-shadow:0 8px 22px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
      #webcam-container{ width:320px; height:320px; margin:6px auto; position:relative; overflow:hidden; border-radius:8px; border:2px solid rgba(76,175,80,0.15); background:#000; }
      #webcam-container canvas{ width:100%; height:100%; display:block; }
      .scanner{ position:absolute; left:0; right:0; top:0; bottom:0; pointer-events:none; }
      .scan-line{ position:absolute; left:-100%; right:-10%; height:400px; top:0; background: linear-gradient(180deg, rgba(255, 0, 0, 0) 0%, rgba(0, 119, 255, 0.15) 45%, rgba(255,255,255,0.25) 55%, rgba(255,255,255,0) 100%); transform:translateY(-100%); filter: drop-shadow(0 6px 10px rgb(0, 0, 0)); }
      .scanning .scan-line{ animation: scanMove 0.7s linear forwards; }
      @keyframes scanMove { 0%{ transform:translateY(-120%); opacity:0; } 10%{ opacity:1; } 100%{ transform:translateY(120%); opacity:0; } }
      .flash { position:absolute; left:0; right:0; top:0; bottom:0; background:white; opacity:0; pointer-events:none; transition: opacity 0.12s ease; }
      .flash.visible{ opacity:0.7; }
      #label-container{ text-align:left; margin-top:8px; font-size:0.95rem; color:#222; }
      .predRow{ padding:4px 6px; border-radius:6px; margin:4px 0; background:rgba(0,0,0,0.02); display:flex; justify-content:space-between; align-items:center; }
      #topPredictionBox{ margin-top:10px; padding:10px; border-radius:10px; background:linear-gradient(180deg,#fff,#eafaf0); border:1px solid rgba(76,175,80,0.18); font-weight:700; display:none; text-align:left; }
      .rightCol{ width:540px; max-width:90%; }
      .galleryCard{ background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 16px rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.04); }
      #gallery{ display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-start; margin-top:10px; }
      .captureCard{ width:160px; border-radius:8px; overflow:hidden; background:#fff; border:1px solid #eee; padding:6px; text-align:center; }
      .captureCard img{ width:100%; height:110px; object-fit:cover; border-radius:6px; display:block; }
      .meta{ font-size:0.82rem; color:#333; margin-top:6px; }
      .downloadBtn{ display:inline-block; margin-top:6px; padding:6px 8px; border-radius:6px; background:var(--accent); color:#fff; text-decoration:none; font-size:0.82rem; }
      .modal-backdrop{ position:fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
      .modal{ width:520px; max-width:95%; background:#fff; border-radius:12px; padding:14px; box-shadow:0 18px 40px rgba(0,0,0,0.25); }
      .modal h3{ margin-top:0; }
      .form-row{ margin:8px 0; text-align:left; }
      .form-row label{ display:block; font-size:0.86rem; margin-bottom:6px; }
      .form-row input[type="text"], .form-row textarea{ width:100%; padding:8px; border-radius:8px; border:1px solid #ddd; font-size:0.95rem; }
      .modal .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
      .btn-secondary{ background:#eee; color:#111; }
      .chatArea{ height:140px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:8px; background:#fafafa; }
      .chatMsg{ margin:6px 0; font-size:0.92rem; }
      .chatMsg.system{ color:#555; font-style:italic; }
      @media (max-width:900px){ .wrap{ flex-direction:column; align-items:center; } .rightCol{ width:92%; } }
      /* small token UI */
      #tokenArea{ margin:8px 0; text-align:left; background:#fff; padding:8px; border-radius:8px; border:1px solid #eee; display:flex; gap:8px; align-items:center; justify-content:space-between; }
      #tokenArea input{ flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; margin-right:8px; }
    </style>
  </head>

<body>
  <h1>Leaf Recognition ‚Äî Scan Capture</h1>
  <p class="lead">Camara preview</p>

  <div id="controls">
    <button id="startBtn">Start Webcam & Model</button>
    <button id="stopBtn" class="stop" style="display:none;">Stop</button>
  </div>

  <div class="wrap">
    <div class="previewCard">
      <div id="webcam-container">
        <div class="scanner" id="scannerOverlay"><div class="scan-line"></div></div>
        <div class="flash" id="flashOverlay"></div>
      </div>

      <div id="topPredictionBox"><span id="topLabel">‚Äî</span><span style="float:right;font-weight:800;" id="topPercent">‚Äî</span>
        <div style="clear:both; margin-top:6px; font-size:0.9rem; color:#444;">Captured at: <span id="topTime">‚Äî</span></div>
      </div>
      <br>
      <button id="toggleResultsBtn">üëÅ Show/Hide Results</button>
      <table id="label-table" style="margin: 10px auto; border-collapse: collapse; display: table;">
          <thead>
              <tr>
                  <th style="border:1px solid #ccc; padding:5px;">Details</th>
              </tr>
          </thead>
          <tbody id="label-container"></tbody>
      </table>

      <div id="label-container"></div>
    </div>

    <div class="rightCol galleryCard">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Captured Images</strong>
        <small style="color:#181313; font-size:0.9rem;">Max: <span id="maxPhotosLabel">Loading...</span></small>
      </div>
      <div id="gallery" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- modal for Ask AI / feedback (main modal) -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="modalTitle">Ask AI about ‚Äî</h3>

      <div class="form-row">
        <label>Item name</label>
        <input type="text" id="modalName" />
      </div>

      <div class="form-row">
        <label>Previous details (system info)</label>
        <div class="chatArea" id="modalPrevDetails"></div>
      </div>

      <div class="form-row">
        <label>Your question / feedback</label>
        <textarea id="modalQuestion" rows="3" placeholder="Type your question for the AI..."></textarea>
      </div>

      <div class="actions">
        <button class="btn-secondary" id="modalClose">Close</button>
        <button id="modalSend">Send to AI</button>
      </div>
    </div>
  </div>

  <!-- TensorFlow.js & Teachable Machine -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

<script>
  // ---- CONFIG ----
  const URL = "./";
  const CAPTURE_WIDTH = 320;
  const CAPTURE_HEIGHT = 320;
  const MIN_DELAY_MS = 1;
  const MAX_DELAY_MS = 5000;
  const MAX_PHOTOS = 3;
  const SCAN_DURATION_MS = 70;

  // state
  let model, webcam, maxPredictions;
  let running = false;
  let captureTimer = null;

  // elements
  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");
  const webcamContainer = document.getElementById("webcam-container");
  const scannerOverlay = document.getElementById("scannerOverlay");
  const flashOverlay = document.getElementById("flashOverlay");
  const topBox = document.getElementById("topPredictionBox");
  const topLabel = document.getElementById("topLabel");
  const topPercent = document.getElementById("topPercent");
  const topTime = document.getElementById("topTime");
  const labelContainer = document.getElementById("label-container");
  const gallery = document.getElementById("gallery");
  document.getElementById("maxPhotosLabel").innerText = MAX_PHOTOS;

  startBtn.addEventListener("click", startAll);
  stopBtn.addEventListener("click", stopAll);

  // ---- Saved Details for Free AI ----
  const savedDetails = {
    "‡∑Ñ‡∑ê‡∂ß‡∑ä‡∂ß ‡∂ö‡∂ß‡∑ä‡∂ß‡∂ö‡∑ä": { description: "LeafA is medicinal, grows in tropical areas.", uses: "Used in herbal teas and poultices.", extra: "Rich in antioxidants." },
    "pensil": { description: "LeafB is edible, used in salads.", uses: "Can be cooked or eaten raw.", extra: "High in vitamin C." },
    "LeafC": { description: "LeafC is ornamental, popular in gardens.", uses: "Used for decoration.", extra: "Requires moderate sunlight." }
  };

  let currentLeafName = "";

  async function startAll(){
    startBtn.disabled = true;
    startBtn.innerText = "Loading model...";
    try {
      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";
      model = await tmImage.load(modelURL, metadataURL);
      maxPredictions = model.getTotalClasses();
    } catch(err){
      alert("Model load failed. Serve files via HTTP (e.g., python -m http.server). Error in console.");
      console.error(err);
      startBtn.disabled = false;
      startBtn.innerText = "Start Webcam & Model";
      return;
    }

    const flip = true;
    webcam = new tmImage.Webcam(CAPTURE_WIDTH, CAPTURE_HEIGHT, flip);
    await webcam.setup();
    await webcam.play();

    webcamContainer.querySelectorAll("canvas").forEach(n => n.remove());
    webcamContainer.appendChild(webcam.canvas);

    labelContainer.innerHTML = "";
    for(let i=0;i<maxPredictions;i++){
      const div = document.createElement("div");
      div.className = "predRow";
      div.innerHTML = `<span id="pn_${i}">‚Äî</span><span id="pp_${i}">‚Äî</span>`;
      labelContainer.appendChild(div);
    }

    running = true;
    stopBtn.style.display = "inline-block";
    startBtn.innerText = "Running";

    window.requestAnimationFrame(loop);
    scheduleNextCapture();
  }

  document.getElementById("toggleResultsBtn").addEventListener("click", () => {
      const table = document.getElementById("label-table");
      table.style.display = (table.style.display === "none") ? "table" : "none";
  });

  function stopAll(){
    running = false;
    if (webcam) webcam.stop();
    if (captureTimer) clearTimeout(captureTimer);
    startBtn.disabled = false;
    startBtn.innerText = "Start Webcam & Model";
    stopBtn.style.display = "none";
    topBox.style.display = "none";
  }

  async function loop(){
    if (!running) return;
    webcam.update();
    await predict(false);
    window.requestAnimationFrame(loop);
  }

  async function predict(showTop=true){
    if (!model) return;
    const prediction = await model.predict(webcam.canvas);
    let best = prediction[0];
    for (let i=0;i<prediction.length;i++){
      const name = prediction[i].className;
      const prob = (prediction[i].probability * 100);
      const elName = document.getElementById(`pn_${i}`);
      const elProb = document.getElementById(`pp_${i}`);
      if (elName) elName.innerText = name;
      if (elProb) elProb.innerText = prob.toFixed(2) + "%";
      if (prediction[i].probability > best.probability) best = prediction[i];
    }
    if (showTop && best){
      showTopPrediction(best.className, (best.probability*100).toFixed(2));
    }
    return prediction;
  }

  function showTopPrediction(name, percent){
    topLabel.innerText = name;
    topPercent.innerText = percent + "%";
    topTime.innerText = new Date().toLocaleTimeString();
    topBox.style.display = "block";
  }

  function scheduleNextCapture(){
    if (!running) return;
    const delay = Math.floor(Math.random() * (MAX_DELAY_MS - MIN_DELAY_MS + 1)) + MIN_DELAY_MS;
    captureTimer = setTimeout(async ()=>{
      startScanAnimation();
      setTimeout(async ()=>{
        await performCapture();
        stopScanAnimation();
        scheduleNextCapture();
      }, SCAN_DURATION_MS);
    }, delay);
  }

  function startScanAnimation(){ scannerOverlay.classList.add("scanning"); }
  function stopScanAnimation(){ scannerOverlay.classList.remove("scanning"); }

  async function performCapture(){
    if (!webcam || !model) return;
    const prediction = await model.predict(webcam.canvas);
    let best = prediction[0];
    for (let i=1;i<prediction.length;i++){
      if (prediction[i].probability > best.probability) best = prediction[i];
    }

    flashOverlay.classList.add("visible");
    setTimeout(()=> flashOverlay.classList.remove("visible"), 200);

    const off = document.createElement("canvas");
    off.width = CAPTURE_WIDTH;
    off.height = CAPTURE_HEIGHT;
    const ctx = off.getContext("2d");
    ctx.drawImage(webcam.canvas, 0, 0, off.width, off.height);
    const dataURL = off.toDataURL("image/png");

    const card = document.createElement("div");
    card.className = "captureCard";
    const img = document.createElement("img");
    img.src = dataURL;
    const meta = document.createElement("div");
    meta.className = "meta";
    const now = new Date();
    const timeStr = now.toLocaleString();
    const predText = best ? `${best.className} (${(best.probability*100).toFixed(2)}%)` : "‚Äî";
    meta.innerHTML = `<strong>${predText}</strong><br><small>${timeStr}</small>`;

    const dl = document.createElement("a");
    dl.className = "downloadBtn";
    dl.href = "#";
    dl.innerText = "ASK AI";
    dl.onclick = (e)=>{ e.preventDefault(); openAIModal(best.className); };

    card.appendChild(img);
    card.appendChild(meta);
    card.appendChild(dl);

    gallery.insertBefore(card, gallery.firstChild);

    showTopPrediction(best.className, (best.probability*100).toFixed(2));
    topTime.innerText = timeStr;

    while (gallery.childNodes.length > MAX_PHOTOS){
      gallery.removeChild(gallery.lastChild);
    }
  }

  window.addEventListener("beforeunload", ()=>{ if (webcam) try{ webcam.stop(); }catch(e){} });

  // ---- Modal AI functions (NEW improved with Hugging Face) ----
  // small helper UI for token + model (we'll append to body so user can set their token)
  (function insertTokenUI(){
    const div = document.createElement('div');
    div.id = 'tokenArea';
    div.innerHTML = `
      <div style="flex:1;">
        <label style="font-size:0.85rem;display:block;margin-bottom:4px;">Hugging Face API Token (paste here)</label>
        <input id="hfTokenInput" placeholder="hf_xxx (keep secret for production)"/>
        <small style="display:block;margin-top:6px;color:#333;font-size:0.8rem;">Model:
          <select id="hfModelSelect">
            <option value="google/flan-t5-large">google/flan-t5-large</option>
            <option value="gpt2">gpt2</option>
            <option value="bigscience/bloomz-560m">bloomz-560m</option>
          </select>
        </small>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        <button id="saveTokenBtn" style="padding:8px;border-radius:8px;background:#1976d2;color:#fff;border:none;cursor:pointer;">Save Token</button>
        <button id="clearTokenBtn" style="padding:8px;border-radius:8px;background:#eee;color:#111;border:none;cursor:pointer;">Clear</button>
      </div>
    `;
    document.body.insertBefore(div, document.body.firstChild);

    // load saved
    const saved = localStorage.getItem('hf_token');
    const savedModel = localStorage.getItem('hf_model') || 'google/flan-t5-large';
    document.getElementById('hfModelSelect').value = savedModel;
    if(saved) document.getElementById('hfTokenInput').value = saved;

    document.getElementById('saveTokenBtn').onclick = ()=> {
      const t = document.getElementById('hfTokenInput').value.trim();
      const m = document.getElementById('hfModelSelect').value;
      if(!t){ alert('Paste your HF token (from https://huggingface.co/settings/tokens)'); return; }
      localStorage.setItem('hf_token', t);
      localStorage.setItem('hf_model', m);
      alert('Token saved to localStorage for this browser (not secure for production).');
    };
    document.getElementById('clearTokenBtn').onclick = ()=> {
      localStorage.removeItem('hf_token');
      localStorage.removeItem('hf_model');
      document.getElementById('hfTokenInput').value = '';
      alert('Token cleared.');
    };
  })();

  // open modal (uses the modal defined above)
  function openAIModal(name){
    currentLeafName = name;
    const modalBackdrop = document.getElementById('modalBackdrop');
    modalBackdrop.style.display = 'flex';
    document.getElementById('modalTitle').innerText = `Ask AI about ‚Äî ${name}`;
    document.getElementById('modalName').value = name;

    const prev = document.getElementById('modalPrevDetails');
    const info = savedDetails[name];
    prev.innerHTML = '';
    if(info){
      prev.innerHTML = `
        <div><strong>Description:</strong> ${info.description}</div>
        <div><strong>Uses:</strong> ${info.uses}</div>
        <div><strong>Extra:</strong> ${info.extra}</div>
      `;
    } else {
      prev.innerHTML = `<div>No saved info available for ${name}</div>`;
    }

    document.getElementById('modalQuestion').value = `Tell me more about ${name} and its traditional uses.`;
  }

  document.getElementById('modalClose').addEventListener('click', ()=> {
    document.getElementById('modalBackdrop').style.display = 'none';
  });

  // main function: uses HF inference API if token present, else fallback to savedDetails
  async function callHuggingFace(prompt){
    const token = localStorage.getItem('hf_token');
    const model = localStorage.getItem('hf_model') || 'google/flan-t5-large';
    if(!token) throw new Error('no_token');

    const url = `https://api-inference.huggingface.co/models/${encodeURIComponent(model)}`;
    const body = JSON.stringify({ inputs: prompt, options: { wait_for_model: true, use_cache: false } });

    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body
    });

    if(!resp.ok){
      const txt = await resp.text();
      throw new Error(`HF response ${resp.status}: ${txt}`);
    }
    const data = await resp.json();
    // different models return different shapes. try to extract sensible text:
    if(Array.isArray(data) && data.length>0){
      // many text-gen models return [{generated_text: "..."}]
      if(data[0].generated_text) return data[0].generated_text;
      // some provide [{summary_text: "..."}] or other keys
      const v = Object.values(data[0]).find(x=>typeof x === 'string');
      if(v) return v;
    }
    if(typeof data === 'string') return data;
    return JSON.stringify(data);
  }

  async function modalSendButtonHandler(){
    const q = document.getElementById('modalQuestion').value.trim();
    const name = document.getElementById('modalName').value.trim() || currentLeafName;
    const chatBox = document.getElementById('modalPrevDetails');

    // show user query in chat area
    appendChat(`You: ${q}`);

    // try HF
    try {
      const token = localStorage.getItem('hf_token');
      if(!token){
        // fallback to savedDetails simulated reply
        const info = savedDetails[name];
        const reply = info ? `üí° (Local info) ${info.description} Uses: ${info.uses}. Extra: ${info.extra}` : `No local info available for ${name}. Please add a Hugging Face token to get AI responses.`;
        appendChat(`AI: ${reply}`);
        return;
      }
      appendChat('AI: ...thinking (calling Hugging Face)...');

      const combinedPrompt = `Item: ${name}\nKnown info: ${ JSON.stringify(savedDetails[name] || {}) }\nUser question: ${q}\nAnswer in Sinhala (if possible) briefly but clearly:`;
      const out = await callHuggingFace(combinedPrompt);
      // replace the 'thinking' message by actual
      replaceLastAIMessage(`AI: ${out}`);
    } catch(err){
      if(err.message === 'no_token'){
        appendChat(`AI: No Hugging Face token found. Paste one in the top input or sign up at https://huggingface.co/settings/tokens`);
      } else {
        appendChat(`AI: Error: ${err.message}`);
        console.error(err);
      }
    }
  }

  // chat helpers
  function appendChat(text){
    const chatArea = document.getElementById('modalPrevDetails');
    const div = document.createElement('div');
    div.className = 'chatMsg';
    div.innerHTML = text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }
  function replaceLastAIMessage(text){
    const chatArea = document.getElementById('modalPrevDetails');
    // find last element starting with 'AI:' or replace last child
    for(let i = chatArea.children.length-1; i>=0; i--){
      const t = chatArea.children[i].innerText || '';
      if(t.startsWith('AI:') || t.startsWith('AI: ...thinking')){
        chatArea.children[i].innerText = text;
        chatArea.scrollTop = chatArea.scrollHeight;
        return;
      }
    }
    appendChat(text);
  }

  document.getElementById('modalSend').addEventListener('click', modalSendButtonHandler);

</script>

<!-- small floating modal "Leaf Chat" placed at end of body for quick chat (keeps your previous smaller UI) -->
<div id="aiModal" style="
    display:none;
    position:fixed;
    top:10%;
    left:50%;
    transform:translateX(-50%);
    width:340px;
    max-width:90%;
    background:#f9f9f9;
    padding:16px;
    border-radius:12px;
    box-shadow:0 12px 24px rgba(0,0,0,0.25);
    z-index:999;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
">
  <h3 style="margin-top:0; margin-bottom:10px; color:#4caf50; text-align:center;">Leaf Chat</h3>

  <div id="aiChatContent" style="
      height:180px;
      overflow-y:auto;
      border:1px solid #ccc;
      border-radius:8px;
      padding:8px;
      margin-bottom:10px;
      background:#fff;
      scrollbar-width:thin;
      scrollbar-color:#4caf50 #eee;
  "></div>

  <input type="text" id="aiQuestion" placeholder="Ask about this leaf..." style="
      width:100%;
      padding:8px;
      margin-bottom:10px;
      border:1px solid #ccc;
      border-radius:8px;
      outline:none;
      transition:0.2s;
  " onfocus="this.style.borderColor='#4caf50';" onblur="this.style.borderColor='#ccc';">

  <div style="display:flex; gap:8px;">
    <button onclick="(async()=>{ await modalSendButtonHandler(); })()" style="
        flex:1;
        padding:8px;
        background:#4caf50;
        color:#fff;
        border:none;
        border-radius:8px;
        cursor:pointer;
        transition:0.2s;
    " onmouseover="this.style.background='#43a047';" onmouseout="this.style.background='#4caf50';">Send</button>

    <button onclick="document.getElementById('aiModal').style.display='none';" style="
        flex:1;
        padding:8px;
        background:#f44336;
        color:#fff;
        border:none;
        border-radius:8px;
        cursor:pointer;
        transition:0.2s;
    " onmouseover="this.style.background='#d32f2f';" onmouseout="this.style.background='#f44336';">Close</button>
  </div>
</div>

</body>
</html>
