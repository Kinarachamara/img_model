<!DOCTYPE html>
<html lang="si">
<head>
  <meta charset="utf-8"/>
  <title>Leaf Recognition — AI Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{ font-family: Arial, sans-serif; background:#f4f9f4; margin:0; padding:0;}
    #aiModal{display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
      width:320px; background:#fff; padding:12px; border-radius:8px;
      box-shadow:0 8px 20px rgba(0,0,0,0.2); z-index:999;}
    #aiModal h3{ margin:0 0 10px; color:#4caf50; }
    #aiChatContent{ height:250px; overflow-y:auto; border:1px solid #ccc;
      padding:6px; border-radius:6px; background:#fafafa;}
    .chatMsg{ margin:6px 0; padding:4px 6px; border-radius:6px;}
    .chatMsg strong{ color:#333; }
    .system{ font-style:italic; color:#888;}
    #aiInput{ width:70%; padding:6px; border:1px solid #aaa; border-radius:4px;}
    #aiSend{ padding:6px 10px; background:#4caf50; color:#fff; border:none;
      border-radius:4px; cursor:pointer;}
  </style>
</head>
<body>

<button onclick="openAiModal('Neem')">Ask AI about Neem Leaf</button>

<div id="aiModal">
  <h3>Leaf Chat</h3>
  <div id="aiChatContent"></div>
  <div style="margin-top:8px;">
    <input id="aiInput" placeholder="Ask something..."/>
    <button id="aiSend">Send</button>
  </div>
</div>

<script>
  // ---------------- CONFIG ----------------
  const HF_API_KEY = "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"; 
  const HF_MODEL = "mistralai/Mistral-7B-Instruct-v0.2"; 

  let currentLeaf = "";

  function openAiModal(name){
    currentLeaf = name;
    document.getElementById("aiModal").style.display="block";
    document.getElementById("aiChatContent").innerHTML = "";
  }

  document.getElementById("aiSend").onclick = ()=>{
    const q = document.getElementById("aiInput").value.trim();
    if(q) modalSend(q, currentLeaf);
    document.getElementById("aiInput").value="";
  }

  async function modalSend(question, name){
    const chatBox = document.getElementById("aiChatContent");

    // User message
    const userDiv = document.createElement("div");
    userDiv.className = "chatMsg";
    userDiv.innerHTML = `<strong>You:</strong> ${question}`;
    chatBox.appendChild(userDiv);

    // Loading msg
    const sysDiv = document.createElement("div");
    sysDiv.className = "chatMsg system";
    sysDiv.innerText = "⏳ AI thinking...";
    chatBox.appendChild(sysDiv);
    chatBox.scrollTop = chatBox.scrollHeight;

    try{
      const response = await fetch(
        `https://api-inference.huggingface.co/models/${HF_MODEL}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${HF_API_KEY}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          inputs: `This is a conversation about a leaf called ${name}. User asked: ${question}`
        })
      });

      const data = await response.json();
      sysDiv.remove(); // remove loading

      const aiDiv = document.createElement("div");
      aiDiv.className = "chatMsg";
      aiDiv.innerHTML = `<strong>AI:</strong> ${data[0]?.generated_text || "⚠️ No reply"}`;
      chatBox.appendChild(aiDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    catch(err){
      sysDiv.innerText = "❌ Error: " + err.message;
    }
  }
</script>

</body>
</html>
